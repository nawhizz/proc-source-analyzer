/*------------------------------------------------------------------------------
 * 주시스템명 : 목우촌 종합관리 시스템
 * 서  버  명 :
 * 서  비  명 : SC_MOG_COMMON
 * 업무  구분 : 공통
 * 업무  단위 :
 * 프로그램명 : 표준함수
 * 서브  함수 : 서비스시작              ---> CF_START_SERVICE()
 *              서비스종료              ---> CF_END_SERVICE()
 *              로그저장                ---> CF_SAVE_LOG()
 *              일반오류처리            ---> CF_SET_ERROR_MSG()
 *              일반오류처리            ---> CF_SET_USER_MSG()
 *              FDL 오류처리            ---> CF_SET_FDL_ERROR_MSG()
 *              다이나믹 SQL            ---> CF_DYNAMIC_SQL()
 * 작  성  자 : 김대웅
 * 작  성  일 : 2006.09.15
  ----------------------------------------------------------------------------
 | 수  정  자  | 수  정  일 |           수     정     내     용              |
  ----------------------------------------------------------------------------
 |  고 한 무   | 2007.02.05 | 목우촌 종합관리 시스템에 맞게 수정             |
 *----------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------
 * Head File Inclue    선언부.
 *----------------------------------------------------------------------------*/
EXEC SQL INCLUDE    "/userdir/nhimog/include/common_main.h";   /* 공통 메인 Head File */
/*------------------------------------------------------------------------------
 * 사용자 Define       선언부.
 *----------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------
 * 시간관련 변수 선언.
 *----------------------------------------------------------------------------*/
struct   tm *t;                                        /* Time.h              */
time_t   sec;                                          /* Time.h              */
/*------------------------------------------------------------------------------
 * FUNCTION ID : CF_START_SERVICE(버퍼크기, 트랜잭션, 서비스화일명, 플래그)
 * 기       능 : 전역변수 초기화, 버퍼 재할당, 세션정보 수신
 * 버 퍼 크 기 : 전송버퍼(tranbuf) 재할당할 크기
 * 트랜잭션처리: TX_XA  -> 전역 트랜잭션 관리
 *               TX_NXA ->      트랜잭션 관리 안함
 * 플   래  그 : 0      -> 전역변수 초기화, 버퍼 재할당, 세션정보 수신
 *               1      -> 전역변수 초기화, 버퍼 재할당
 * 반   환  값 : 0      -> 정상 , 그외 오류코드
 *----------------------------------------------------------------------------*/
int CF_START_SERVICE(int buff_size, int txtype, char *file_name, int flag)
{
    /*--------------------------------------------------------------------------
     * 변수 선언.
     *------------------------------------------------------------------------*/
    char *ptrfile;
    /*--------------------------------------------------------------------------
     * 전역변수 초기화.
     *------------------------------------------------------------------------*/
    INITSTRU(evar                 );                   /* 전역변수 초기화     */
    CHARTOVAR(evar.yn_user_err,"N");
    /*--------------------------------------------------------------------------
     * 전역변수 설정.
     *------------------------------------------------------------------------*/
    evar.result = FAIL;                        /* 처리결과 Default로 FAIL설정 */
    evar.txtype = txtype;                      /* Tx Type                     */

    ptrfile = strrchr(file_name,'_')+1;
    SUBSTR(evar.id_program.arr, ptrfile, 0, strlen(ptrfile)-3);
    evar.id_program.len = strlen(evar.id_program.arr); /* 프로그램명 'MO_'제외*/
    time(&sec);                                        /* 타임설정            */
    t = localtime(&sec);                               /* 현 SYSTEM DATETIME  */
    sprintf(evar.tm_start_service.arr,"%02d%02d%02d",t->tm_hour,t->tm_min,t->tm_sec);
    evar.tm_start_service.len = strlen(evar.tm_start_service.arr);
    /*--------------------------------------------------------------------------
     * Global Transaction(전역 트랜잭션 관련) 처리.
     *------------------------------------------------------------------------*/
    int     txret = 0;                                 /* 트랜잭션 변수 선언  */
    TXINFO  txinfo;                                    /* 트랜잭션 정보 선언  */
    txret   = tx_info((TXINFO *)&txinfo);
    if (txret == 1 && evar.txtype == TX_XA)            /* 재 XA모드 설정시    */
    {
        tx_rollback();
        return(FAIL);
    }
    if (evar.txtype == TX_XA)
    {
        txret = tx_begin();                            /* 전역 트랜잭션 시작  */
        if (txret < 0)
        {
            return(FAIL);
        };
    }
    /*--------------------------------------------------------------------------
     * FDL Buffer 재할당 작업.
     *------------------------------------------------------------------------*/
    TP_REALLOC(tranbuf, buff_size);
    if (evar.fb_error > 0) /* Tmax Buffer 할당 오류 시 처리 */
    {
        return(FAIL);
    }
    /*--------------------------------------------------------------------------
     * 서비스모드 부분에 해당하는 TMAX 버퍼의 값을 변수로 가져오기.
     *------------------------------------------------------------------------*/
    FB_GET_V(tranbuf, INF001, evar.gbn_service , "서비스모드  ");
    if (evar.fb_error > 0) /* Tmax Buffer 할당 오류 시 처리 */
    {

        return(FAIL);
    }
    /*--------------------------------------------------------------------------
     * 플래그 0인 경우 세션정보 수신.
     *------------------------------------------------------------------------*/
    if (flag == 0)
    {
        /*----------------------------------------------------------------------
         * 세션부분에 해당하는 TMAX 버퍼의 값을 변수로 가져오기.
         *--------------------------------------------------------------------*/
        FB_GET_V(tranbuf, INF002, evar.id_user          , "사용자ID                                           ");
        FB_GET_V(tranbuf, INF002, evar.nm_user          , "성명                                               ");
        FB_GET_I(tranbuf, INF002, evar.cd_samuso_i      , "사무소코드                                         ");
        FB_GET_V(tranbuf, INF002, evar.cd_samuso        , "사무소코드                                         ");
        FB_GET_V(tranbuf, INF002, evar.nm_samuso        , "사무소이름                                         ");
        FB_GET_V(tranbuf, INF002, evar.cd_dept          , "부서코드                                           ");
        FB_GET_V(tranbuf, INF002, evar.nm_dept          , "부서명                                             ");
        FB_GET_V(tranbuf, INF002, evar.cd_jikgeub       , "직급코드                                           ");
        FB_GET_V(tranbuf, INF002, evar.cd_jikmyung      , "직명코드                                           ");
        FB_GET_V(tranbuf, INF002, evar.address_ip       , "사용자 IP                                          ");
        FB_GET_C(tranbuf, INF002, evar.gbn_user         , "사용자구분(농협,슈퍼바이저,지사,가맹점,체인점,농가)");
        FB_GET_V(tranbuf, INF002, evar.cd_whouse        , "창고코드                                           ");
        FB_GET_V(tranbuf, INF002, evar.cd_branch        , "영업소(지점)코드                                   ");
        FB_GET_C(tranbuf, INF002, evar.gbn_login        , "로그인구분                                         ");

        FB_GET_V(tranbuf, INF003, evar.jsp_program      , "호출한 JSP 프로그램 ID                             ");
        FB_GET_I(tranbuf, INF004, evar.seq_jsp_program  , "호출한 JSP 프로그램 SEQ                            ");
        FB_GET_V(tranbuf, INF010, evar.dyn_sql          , "Dynamic SQL(from JSP)                              ");

/*
        FB_GET_V(tranbuf, INF002, evar.no_sawon        , "사원번호            ");
        FB_GET_V(tranbuf, INF002, evar.nm_sawon        , "성명                ");
        FB_GET_V(tranbuf, INF002, evar.code_company    , "회사코드            ");
        FB_GET_V(tranbuf, INF002, evar.code_samuso     , "사무소코드          ");
        FB_GET_V(tranbuf, INF002, evar.nm_samuso       , "사무소명            ");
        FB_GET_V(tranbuf, INF002, evar.type_samuso     , "사무소형태          ");
        FB_GET_V(tranbuf, INF002, evar.code_samuso_jib , "기본 집계사무소코드 ");
        FB_GET_V(tranbuf, INF002, evar.code_buseo      , "부서코드            ");
        FB_GET_V(tranbuf, INF002, evar.nm_buseo        , "부서명              ");
        FB_GET_V(tranbuf, INF002, evar.gbn_jikwon      , "직원구분            ");
        FB_GET_V(tranbuf, INF002, evar.code_jikgeub    , "직급코드            ");
        FB_GET_V(tranbuf, INF002, evar.code_jikmyung   , "직명코드            ");
        FB_GET_V(tranbuf, INF002, evar.dt_pay          , "최종급여지급일      ");
        FB_GET_V(tranbuf, INF002, evar.gbn_pay         , "급여지급구분        ");
        FB_GET_V(tranbuf, INF002, evar.nm_pay          , "급여구분명          ");
        FB_GET_V(tranbuf, INF002, evar.code_samuso_ji  , "지급사무소코드      ");
        FB_GET_V(tranbuf, INF002, evar.code_samuso_pa  , "근무(파견)사무소코드");
        FB_GET_V(tranbuf, INF002, evar.auth_hr         , "인사권한            ");
        FB_GET_V(tranbuf, INF002, evar.auth_py         , "급여권한            ");
        FB_GET_V(tranbuf, INF002, evar.auth_ac         , "회계권한            ");
        FB_GET_V(tranbuf, INF002, evar.auth_mi         , "경영정보권한        ");
        FB_GET_V(tranbuf, INF002, evar.auth_us         , "시스템권한          ");
        FB_GET_V(tranbuf, INF002, evar.auth_sd         , "영업관리권한        ");
        FB_GET_V(tranbuf, INF002, evar.auth_pp         , "생산관리권한        ");
        FB_GET_V(tranbuf, INF002, evar.auth_ec         , "경제공통권한        ");
        FB_GET_V(tranbuf, INF002, evar.auth_am         , "감사관리권한        ");
        FB_GET_V(tranbuf, INF002, evar.yakjeong        , "약정내역            ");
        FB_GET_V(tranbuf, INF002, evar.ip_addr         , "IP 주소             ");

        FB_GET_I(tranbuf, INF004, evar.cur_page        , "현재PAGE            ");
        FB_GET_I(tranbuf, INF004, evar.cnt_row_page    , "PAGE당 건수         ");
        FB_GET_V(tranbuf, INF005, evar.code_system     , "현재실행업무        ");
*/
        /*----------------------------------------------------------------------
         * INF011 ~ INF020 까지는 Dynamic SQL 관련 버퍼
         *--------------------------------------------------------------------*/
/*
        FB_GET_C(tranbuf, INF019, evar.commit_yn       , "Commit 여부         ");
        FB_GET_V(tranbuf, INF020, evar.dyn_sql         , "Dynamic SQL         ");
*/

        if (evar.cur_page == 0 && evar.cnt_row_page == 0)
        {
            evar.cur_page = 1;
            evar.cnt_row_page = 99999;
        }
        if (evar.fb_error > 0)                /* Tmax Buffer Get 오류 시 처리 */
        {
            return(FAIL);
        }

        if( CF_CHECK_TONGJAE() == FAIL )
        {
            CHARTOVAR(evar.yn_user_err,"Y");
            sprintf(evar.msg.arr,"전산시스템의 안정적인 운영을 위해 점검 중에 있습니다.\n다소 불편하시더라도 양해해 주시고 빠른 복구를 위해\n최선을 다 하겠습니다.");
            evar.msg.len = strlen(evar.msg.arr);
            return(FAIL);
        }
    }
    /*--------------------------------------------------------------------------
     * 기본로그 출력.
     *------------------------------------------------------------------------*/
    if (tpextsvcname((char *)tranbuf, evar.svc_program.arr) < 0)
    {
        CHARTOVAR(evar.yn_user_err,"Y");
        sprintf(evar.msg.arr,"서비스명 가져오기 중 오류!!! 담당자에게 문의하세요.");
        evar.msg.len = strlen(evar.msg.arr);
        return(FAIL);
    }
    printf("\n\n\n [%s] 서비스가 시작되었습니다. (시작시간 :: [%s], 서비스모드 :: [%s], 호출 JSP :: [%s]\n\n", evar.svc_program.arr, evar.tm_start_service.arr
                                                                                                             , evar.gbn_service.arr, evar.jsp_program.arr         );
    /*--------------------------------------------------------------------------
     * 로그 Insert.
     *------------------------------------------------------------------------*/
    CF_SAVE_LOG_START();
    
    /*--------------------------------------------------------------------------
     * 처리결과 SUCCESS 리턴.
     *------------------------------------------------------------------------*/
    return(SUCCESS);
}
/*------------------------------------------------------------------------------
 * FUNCTION ID : CF_END_SERVICE(로그기록여부)
 * 기       능 : 처리결과, 메모리FREE, tpreturn 처리
 * 트랜잭션처리: TX_XA  -> 전역 트랜잭션 관리
 *               TX_NXA ->      트랜잭션 관리 안함
 * 반   환  값 : 없음
 *----------------------------------------------------------------------------*/
void CF_END_SERVICE(int yn_log)
{
    /*--------------------------------------------------------------------------
     * Global Transaction(전역 트랜잭션 관련) 변수 선언.
     *------------------------------------------------------------------------*/
    int     txret = 0;                                /* 트랜잭션 변수 선언   */
    TXINFO  txinfo;                                   /* 트랜잭션 정보 선언   */

    /*--------------------------------------------------------------------------
     * 전역변수 설정.
     *------------------------------------------------------------------------*/
    time(&sec);                                        /* 타임설정            */

    t = localtime(&sec);                               /* 현 SYSTEM DATETIME  */
    sprintf((char *)evar.tm_end_service.arr,"%02d%02d%02d",t->tm_hour,t->tm_min,t->tm_sec);
    evar.tm_end_service.len = strlen(evar.tm_end_service.arr);
    /*--------------------------------------------------------------------------
     * FDL 버퍼나 malloc 한 메모리 FREE.
     *------------------------------------------------------------------------*/
    FB_FREE(recvbuf                    );             /* 수신버퍼             */
    FB_FREE(sendbuf                    );             /* 송신버퍼             */
    /*--------------------------------------------------------------------------
     * 처리 결과 최종확인 후 처리.
     *------------------------------------------------------------------------*/
    if (evar.result == SUCCESS)
    {
        if (evar.txtype == TX_XA)
        {
            txret = tx_commit();                      /* XA 전역트랜잭션 커밋 */
            if (txret < 0)
            {
                tx_rollback();                        /* XA 전역트랜잭션 롤백 */
                CHARTOVAR(evar.msg, "전역트랜잭션 커밋 중 오류가 발생하여 롤백 하였습니다. 농협정보시스템 담당자에게 연락하세요!!!");
                FB_PUT_V(tranbuf, INF013, evar.msg,  "메세지반환");
                CF_SAVE_LOG(yn_log, "2");
                TP_RETURN_ERROR(tranbuf);
            }
        }
        else if (evar.txtype == TX_NXA)
        {
            EXEC SQL COMMIT WORK;
        }
/*
        if (strcmp(evar.msg.arr,"") == 0 &&
           (strncmp(evar.id_program.arr, "SD", 2) == 0||
            strncmp(evar.id_program.arr, "PP", 2) == 0||
            strncmp(evar.id_program.arr, "EC", 2) == 0))
        {
*/
            switch (evar.gbn_service.arr[0])
            {
              case 'I' :
                  CHARTOVAR(evar.msg, "정상적으로 저장되었습니다.");
                  break;
              case 'U' :
                  CHARTOVAR(evar.msg, "정상적으로 수정되었습니다.");
                  break;
              case 'D' :
                  CHARTOVAR(evar.msg, "정상적으로 삭제되었습니다.");
                  break;
/*
              case 'P' :
                  CHARTOVAR(evar.msg, "정상적으로 처리되었습니다.");
                  break;
*/
              case 'S' :
                  if (evar.cnt_total == 0)
                  {
                      /*CHARTOVAR(evar.msg, "조건에 일치하는 데이타가 존재하지 않습니다.");*/
                  }
                  else
                  {
                      /* CHARTOVAR(evar.msg, "정상적으로 조회되었습니다."); */
                  }
                  break;
              default :
                  CHARTOVAR(evar.msg, "정상적으로 처리되었습니다.");
                  break;
            }
/*
        }
*/
        CHARTOVAR(evar.yn_user_err,"Y");
        FB_PUT_V(tranbuf, INF011, evar.yn_user_err   , "사용자에러여부");
        FB_PUT_V(tranbuf, INF012, evar.msg           , "메세지반환    ");
        FB_PUT_I(tranbuf, INF013, evar.cnt_total     , "총건수        ");
        FB_PUT_V(tranbuf, INF014, evar.dyn_sql,  "SQL");
/*
        FB_PUT_I(tranbuf, INF004, evar.cur_page      , "현재PAGE      ");
        FB_PUT_I(tranbuf, INF004, evar.cnt_row_page  , "PAGE당 건수   ");
*/
        CF_SAVE_LOG(yn_log, "1"); /* 에러 없는데 로그 남김 */

        /*----------------------------------------------------------------------
         * 기본로그 출력.
         *--------------------------------------------------------------------*/
        printf("\n\n\n [%s] 서비스가 정상 종료되었습니다. (종료시간 :: [%s], 서비스모드 :: [%s], 호출 JSP :: [%s], 총 건수 [%d]\n\n", evar.svc_program.arr, evar.tm_end_service.arr
                                                                                                                                    , evar.gbn_service.arr, evar.jsp_program.arr         
                                                                                                                                    , evar.cnt_total                                    );
/*
fbprint(tranbuf);
*/
        TP_RETURN(tranbuf);
    }
    else
    {
        if (evar.txtype == TX_XA)
        {
            tx_rollback();                            /* XA 전역트랜잭션 롤백 */
        }
        else if (evar.txtype == TX_NXA)
        {
            EXEC SQL ROLLBACK WORK;                   /* LXA 트랜잭션 롤백    */
        }

        FB_PUT_V(tranbuf, INF014, evar.dyn_sql,  "SQL");
        FB_PUT_V(tranbuf, INF011, evar.yn_user_err   , "사용자에러여부");
        FB_PUT_V(tranbuf, INF012, evar.msg           , "메세지반환    ");
        FB_PUT_I(tranbuf, INF013, 0                  , "총건수        ");

        CF_SAVE_LOG(yn_log, "2"); /* 에러 있어서 로그 남김 */

        /*----------------------------------------------------------------------
         * 기본로그 출력.
         *--------------------------------------------------------------------*/
        printf("\n\n\n [%s] 서비스가 오류 종료되었습니다. (종료시간 :: [%s], 서비스모드 :: [%s], 호출 JSP :: [%s]\n오류 ::: [%s]\n\n\n", evar.svc_program.arr, evar.tm_end_service.arr
                                                                                                                                       , evar.gbn_service.arr, evar.jsp_program.arr         
                                                                                                                                       , evar.msg.arr                                   );
/*
fbprint(tranbuf);
*/
        TP_RETURN_ERROR(tranbuf);
    }
}
